# ç¬¬å››ç« ï¼šTCP æ‹¥å¡æ§åˆ¶

## 4.1 ä»€ä¹ˆæ˜¯ç½‘ç»œæ‹¥å¡ï¼Ÿ

**æ‹¥å¡**ï¼ˆCongestionï¼‰æ˜¯æŒ‡ç½‘ç»œä¸­çš„æ•°æ®åŒ…è¶…è¿‡ç½‘ç»œçš„å¤„ç†èƒ½åŠ›ï¼Œå¯¼è‡´ï¼š
- è·¯ç”±å™¨ç¼“å†²åŒºæº¢å‡º
- æ•°æ®åŒ…ä¸¢å¤±
- å»¶è¿Ÿå¢åŠ 
- ååé‡ä¸‹é™

### æ‹¥å¡ä¸æµé‡æ§åˆ¶çš„åŒºåˆ«

| ç»´åº¦ | æµé‡æ§åˆ¶ | æ‹¥å¡æ§åˆ¶ |
|------|----------|----------|
| **ç›®çš„** | é˜²æ­¢å‘é€æ–¹å‹å®æ¥æ”¶æ–¹ | é˜²æ­¢å‘é€æ–¹å‹å®ç½‘ç»œ |
| **ä½œç”¨èŒƒå›´** | ç«¯åˆ°ç«¯ï¼ˆç‚¹å¯¹ç‚¹ï¼‰ | æ•´ä¸ªç½‘ç»œ |
| **æ§åˆ¶ä¾æ®** | æ¥æ”¶æ–¹é€šå‘Šçª—å£ | ç½‘ç»œçŠ¶å†µï¼ˆä¸¢åŒ…ã€RTTï¼‰ |
| **æœºåˆ¶** | æ»‘åŠ¨çª—å£ | æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ã€å¿«é€Ÿé‡ä¼ /æ¢å¤ |

```mermaid
graph LR
    A[å‘é€æ–¹] -->|å—é™äº| B[æµé‡æ§åˆ¶çª—å£<br/>é˜²æ­¢å‹å®æ¥æ”¶æ–¹]
    A -->|å—é™äº| C[æ‹¥å¡æ§åˆ¶çª—å£<br/>é˜²æ­¢å‹å®ç½‘ç»œ]
    B --> D[å®é™…å‘é€çª—å£<br/>= minä¸¤è€…]
    C --> D

    style B fill:#c8e6c9
    style C fill:#fff59d
    style D fill:#bbdefb
```

**å‘é€çª—å£**ï¼š
```
å‘é€çª—å£ = min(æ¥æ”¶çª—å£ rwnd, æ‹¥å¡çª—å£ cwnd)
```

## 4.2 TCP æ‹¥å¡æ§åˆ¶çš„å››å¤§ç®—æ³•

æ ¹æ® RFC 5681ï¼ŒTCP æ‹¥å¡æ§åˆ¶åŒ…å«å››ä¸ªæ ¸å¿ƒç®—æ³•ï¼š

```mermaid
graph TD
    A[TCP æ‹¥å¡æ§åˆ¶] --> B[æ…¢å¯åŠ¨<br/>Slow Start]
    A --> C[æ‹¥å¡é¿å…<br/>Congestion Avoidance]
    A --> D[å¿«é€Ÿé‡ä¼ <br/>Fast Retransmit]
    A --> E[å¿«é€Ÿæ¢å¤<br/>Fast Recovery]

    style B fill:#c8e6c9
    style C fill:#fff59d
    style D fill:#ffcdd2
    style E fill:#e1bee7
```

### æ ¸å¿ƒå˜é‡

| å˜é‡ | å«ä¹‰ | åˆå§‹å€¼ |
|------|------|--------|
| **cwnd** | æ‹¥å¡çª—å£ï¼ˆCongestion Windowï¼‰ | IWï¼ˆåˆå§‹çª—å£ï¼‰ |
| **ssthresh** | æ…¢å¯åŠ¨é˜ˆå€¼ï¼ˆSlow Start Thresholdï¼‰ | ä»»æ„å¤§å€¼ï¼ˆå¦‚ 65535ï¼‰ |
| **rwnd** | æ¥æ”¶çª—å£ï¼ˆReceiver Windowï¼‰ | æ¥æ”¶æ–¹é€šå‘Š |
| **MSS** | æœ€å¤§æŠ¥æ–‡æ®µå¤§å°ï¼ˆMaximum Segment Sizeï¼‰ | åå•†å€¼ï¼ˆé€šå¸¸ 1460ï¼‰ |

## 4.3 æ…¢å¯åŠ¨ï¼ˆSlow Startï¼‰

### 4.3.1 æ…¢å¯åŠ¨çš„åŠ¨æœº

è¿æ¥å»ºç«‹æ—¶ï¼Œå‘é€æ–¹ä¸çŸ¥é“ç½‘ç»œå®¹é‡ï¼Œå¦‚æœç«‹å³å‘é€å¤§é‡æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´æ‹¥å¡ã€‚æ…¢å¯åŠ¨é‡‡ç”¨**æŒ‡æ•°å¢é•¿**ç­–ç•¥ï¼Œå¿«é€Ÿæ¢æµ‹ç½‘ç»œå®¹é‡ã€‚

### 4.3.2 æ…¢å¯åŠ¨ç®—æ³•

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¯æ”¶åˆ°ä¸€ä¸ª ACKï¼Œ`cwnd += MSS`ï¼ˆæˆ–å¢åŠ  1 ä¸ªæŠ¥æ–‡æ®µï¼‰ã€‚

**åˆå§‹çª—å£ï¼ˆIWï¼‰**ï¼š
```
If MSS > 2190 bytes:
    IW = 2 Ã— MSS  (ä¸è¶…è¿‡ 2 ä¸ªæŠ¥æ–‡æ®µ)
If 1095 < MSS â‰¤ 2190 bytes:
    IW = 3 Ã— MSS  (ä¸è¶…è¿‡ 3 ä¸ªæŠ¥æ–‡æ®µ)
If MSS â‰¤ 1095 bytes:
    IW = 4 Ã— MSS  (ä¸è¶…è¿‡ 4 ä¸ªæŠ¥æ–‡æ®µ)

å¸¸è§æƒ…å†µï¼ˆMSS=1460ï¼‰ï¼š
IW = 3 Ã— 1460 = 4380 å­—èŠ‚ (çº¦ 3 ä¸ªæŠ¥æ–‡æ®µ)
```

**æ…¢å¯åŠ¨æµç¨‹**ï¼š
```
cwnd < ssthresh æ—¶ï¼Œæ‰§è¡Œæ…¢å¯åŠ¨ï¼š
æ¯æ”¶åˆ° 1 ä¸ª ACKï¼Œcwnd += MSS
```

### 4.3.3 æ…¢å¯åŠ¨ç¤ºä¾‹

```mermaid
sequenceDiagram
    participant S as å‘é€æ–¹<br/>cwnd=1
    participant N as ç½‘ç»œ
    participant R as æ¥æ”¶æ–¹

    Note over S: RTT 1: cwnd=1<br/>å‘é€ 1 ä¸ªæŠ¥æ–‡æ®µ
    S->>N: æŠ¥æ–‡æ®µ 1 (MSS)
    N->>R: æŠ¥æ–‡æ®µ 1
    R->>N: ACK 1
    N->>S: ACK 1
    Note over S: cwnd = 1 + 1 = 2

    Note over S: RTT 2: cwnd=2<br/>å‘é€ 2 ä¸ªæŠ¥æ–‡æ®µ
    S->>N: æŠ¥æ–‡æ®µ 2 (MSS)
    S->>N: æŠ¥æ–‡æ®µ 3 (MSS)
    N->>R: æŠ¥æ–‡æ®µ 2, 3
    R->>N: ACK 2
    R->>N: ACK 3
    N->>S: ACK 2, 3
    Note over S: cwnd = 2 + 2 = 4

    Note over S: RTT 3: cwnd=4<br/>å‘é€ 4 ä¸ªæŠ¥æ–‡æ®µ
    S->>N: æŠ¥æ–‡æ®µ 4-7
    N->>R: æŠ¥æ–‡æ®µ 4-7
    R->>N: ACK 4-7
    N->>S: ACK 4-7
    Note over S: cwnd = 4 + 4 = 8

    Note over S: æŒ‡æ•°å¢é•¿ï¼š1 â†’ 2 â†’ 4 â†’ 8 â†’ 16 ...
```

**å¢é•¿æ›²çº¿**ï¼š

```mermaid
---
config:
  xyChart:
    width: 800
    height: 400
---
xychart-beta
    title "æ…¢å¯åŠ¨ï¼šæ‹¥å¡çª—å£æŒ‡æ•°å¢é•¿"
    x-axis "RTT è½®æ¬¡" 0 --> 10
    y-axis "cwnd (MSS å•ä½)" 0 --> 100
    line [1, 2, 4, 8, 16, 32, 64, 64, 64, 64, 64]
```

**ç»“æŸæ¡ä»¶**ï¼š
1. `cwnd â‰¥ ssthresh` â†’ è½¬å…¥æ‹¥å¡é¿å…
2. æ£€æµ‹åˆ°ä¸¢åŒ… â†’ è°ƒæ•´ `ssthresh`ï¼Œå¯èƒ½é‡æ–°æ…¢å¯åŠ¨

### 4.3.4 Linux æ…¢å¯åŠ¨å‚æ•°

```bash
# æŸ¥çœ‹åˆå§‹æ‹¥å¡çª—å£ï¼ˆå•ä½ï¼šMSSï¼‰
sysctl net.ipv4.tcp_init_cwnd
# è¾“å‡º: net.ipv4.tcp_init_cwnd = 10

# æŸ¥çœ‹æ…¢å¯åŠ¨é˜ˆå€¼åˆå§‹å€¼
sysctl net.ipv4.tcp_init_ssthresh
# è¾“å‡º: net.ipv4.tcp_init_ssthresh = 2147483647 (ä»»æ„å¤§å€¼)

# å®æ—¶æŸ¥çœ‹è¿æ¥çš„ cwnd
ss -tino | grep -A 1 ESTAB | grep cwnd

# è¾“å‡ºç¤ºä¾‹ï¼š
#  cubic wscale:7,7 rto:204 rtt:3.5/1.75 cwnd:10 ssthresh:32
```

**å­—æ®µè§£è¯»**ï¼š
- `cwnd:10` â†’ å½“å‰æ‹¥å¡çª—å£ = 10 MSS
- `ssthresh:32` â†’ æ…¢å¯åŠ¨é˜ˆå€¼ = 32 MSS

## 4.4 æ‹¥å¡é¿å…ï¼ˆCongestion Avoidanceï¼‰

### 4.4.1 æ‹¥å¡é¿å…çš„åŠ¨æœº

æ…¢å¯åŠ¨çš„æŒ‡æ•°å¢é•¿å¤ªæ¿€è¿›ï¼Œå½“ `cwnd â‰¥ ssthresh` æ—¶ï¼Œåˆ‡æ¢åˆ°**çº¿æ€§å¢é•¿**ï¼Œå°å¿ƒç¿¼ç¿¼åœ°å¢åŠ çª—å£ã€‚

### 4.4.2 æ‹¥å¡é¿å…ç®—æ³•

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¯ç»è¿‡ä¸€ä¸ª RTTï¼Œ`cwnd += MSS`ï¼ˆçº¿æ€§å¢é•¿ï¼‰ã€‚

**å®ç°**ï¼š
```
æ¯æ”¶åˆ°ä¸€ä¸ª ACK:
    cwnd += MSS Ã— MSS / cwnd
    (æ¯ä¸ª RTT å¢åŠ çº¦ 1 MSS)
```

### 4.4.3 æ‹¥å¡é¿å…ç¤ºä¾‹

```mermaid
sequenceDiagram
    participant S as å‘é€æ–¹<br/>cwnd=ssthresh=8
    participant R as æ¥æ”¶æ–¹

    Note over S: RTT 1: cwnd=8<br/>å‘é€ 8 ä¸ªæŠ¥æ–‡æ®µ
    S->>R: æŠ¥æ–‡æ®µ 1-8
    R->>S: ACK 1-8 (8 ä¸ª ACK)
    Note over S: cwnd = 8 + 8Ã—MSS/8<br/>= 8 + 1 = 9

    Note over S: RTT 2: cwnd=9<br/>å‘é€ 9 ä¸ªæŠ¥æ–‡æ®µ
    S->>R: æŠ¥æ–‡æ®µ 9-17
    R->>S: ACK 9-17 (9 ä¸ª ACK)
    Note over S: cwnd = 9 + 9Ã—MSS/9<br/>= 9 + 1 = 10

    Note over S: RTT 3: cwnd=10<br/>å‘é€ 10 ä¸ªæŠ¥æ–‡æ®µ
    S->>R: æŠ¥æ–‡æ®µ 18-27
    R->>S: ACK 18-27 (10 ä¸ª ACK)
    Note over S: cwnd = 10 + 10Ã—MSS/10<br/>= 10 + 1 = 11

    Note over S: çº¿æ€§å¢é•¿ï¼š8 â†’ 9 â†’ 10 â†’ 11 ...
```

**å¢é•¿æ›²çº¿**ï¼š

```mermaid
---
config:
  xyChart:
    width: 800
    height: 400
---
xychart-beta
    title "æ…¢å¯åŠ¨ + æ‹¥å¡é¿å…"
    x-axis "RTT è½®æ¬¡" 0 --> 20
    y-axis "cwnd (MSS å•ä½)" 0 --> 70
    line [1, 2, 4, 8, 16, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47]
```

**è¯´æ˜**ï¼š
- RTT 1-5ï¼šæ…¢å¯åŠ¨é˜¶æ®µï¼ŒæŒ‡æ•°å¢é•¿ï¼ˆ1 â†’ 32ï¼‰
- RTT 6-20ï¼šæ‹¥å¡é¿å…é˜¶æ®µï¼Œçº¿æ€§å¢é•¿ï¼ˆ32 â†’ 47ï¼‰
- `ssthresh = 32`

## 4.5 å¿«é€Ÿé‡ä¼ ï¼ˆFast Retransmitï¼‰

### 4.5.1 å¿«é€Ÿé‡ä¼ çš„åŠ¨æœº

ç­‰å¾… RTO è¶…æ—¶å¤ªæ…¢ï¼ˆé€šå¸¸æ•°ç™¾æ¯«ç§’ï¼‰ï¼Œå¿«é€Ÿé‡ä¼ åˆ©ç”¨**é‡å¤ ACK** å¿«é€Ÿæ£€æµ‹ä¸¢åŒ…ã€‚

### 4.5.2 å¿«é€Ÿé‡ä¼ ç®—æ³•

**è§¦å‘æ¡ä»¶**ï¼šæ”¶åˆ° **3 ä¸ªé‡å¤ ACK**ã€‚

**æ“ä½œ**ï¼š
1. ç«‹å³é‡ä¼ ä¸¢å¤±çš„æŠ¥æ–‡æ®µ
2. è®¾ç½® `ssthresh = max(é£è¡Œä¸­çš„å­—èŠ‚æ•° / 2, 2 Ã— MSS)`
3. è¿›å…¥å¿«é€Ÿæ¢å¤

### 4.5.3 å¿«é€Ÿé‡ä¼ ç¤ºä¾‹

```mermaid
sequenceDiagram
    participant S as å‘é€æ–¹<br/>cwnd=10
    participant R as æ¥æ”¶æ–¹

    S->>R: â‘  seq=1000, len=100
    R->>S: ACK ack=1100

    S->>R: â‘¡ seq=1100, len=100
    Note over R: æ•°æ®åŒ…ä¸¢å¤± âŒ

    S->>R: â‘¢ seq=1200, len=100
    R->>S: é‡å¤ACK #1<br/>ack=1100

    S->>R: â‘£ seq=1300, len=100
    R->>S: é‡å¤ACK #2<br/>ack=1100

    S->>R: â‘¤ seq=1400, len=100
    R->>S: é‡å¤ACK #3<br/>ack=1100

    Note over S: æ”¶åˆ° 3 ä¸ªé‡å¤ ACK<br/>è§¦å‘å¿«é€Ÿé‡ä¼ 

    Note over S: ssthresh = cwnd / 2 = 5<br/>cwnd = ssthresh + 3 = 8

    S->>R: å¿«é€Ÿé‡ä¼ <br/>seq=1100, len=100

    R->>S: ACK ack=1500<br/>(ç¡®è®¤æ‰€æœ‰å·²æ”¶åˆ°çš„æ•°æ®)

    Note over S: è¿›å…¥æ‹¥å¡é¿å…<br/>cwnd = ssthresh = 5
```

## 4.6 å¿«é€Ÿæ¢å¤ï¼ˆFast Recoveryï¼‰

### 4.6.1 å¿«é€Ÿæ¢å¤çš„åŠ¨æœº

å¿«é€Ÿé‡ä¼ åï¼Œå¦‚æœç›´æ¥å›åˆ°æ…¢å¯åŠ¨ï¼Œçª—å£ä» 1 å¼€å§‹ï¼Œæµªè´¹ç½‘ç»œå®¹é‡ã€‚å¿«é€Ÿæ¢å¤åœ¨ `ssthresh` é™„è¿‘é‡å¯ï¼Œå¿«é€Ÿæ¢å¤ååé‡ã€‚

### 4.6.2 å¿«é€Ÿæ¢å¤ç®—æ³•ï¼ˆTCP Renoï¼‰

**æ­¥éª¤**ï¼š

1. **æ”¶åˆ° 3 ä¸ªé‡å¤ ACK æ—¶**ï¼š
   ```
   ssthresh = max(é£è¡Œä¸­çš„å­—èŠ‚æ•° / 2, 2 Ã— MSS)
   cwnd = ssthresh + 3 Ã— MSS
   é‡ä¼ ä¸¢å¤±çš„æŠ¥æ–‡æ®µ
   ```

2. **æ”¶åˆ°æ›´å¤šé‡å¤ ACK æ—¶**ï¼ˆä¸´æ—¶è†¨èƒ€ï¼‰ï¼š
   ```
   cwnd += MSS
   (æ¯ä¸ªé‡å¤ ACK è¡¨ç¤ºä¸€ä¸ªæŠ¥æ–‡æ®µå·²ç¦»å¼€ç½‘ç»œ)
   ```

3. **æ”¶åˆ°æ–° ACK æ—¶**ï¼ˆç¡®è®¤æ–°æ•°æ®ï¼‰ï¼š
   ```
   cwnd = ssthresh
   è¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µ
   ```

### 4.6.3 å¿«é€Ÿæ¢å¤æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> SlowStart: è¿æ¥å»ºç«‹
    SlowStart --> CongestionAvoidance: cwnd â‰¥ ssthresh

    CongestionAvoidance --> FastRetransmit: æ”¶åˆ° 3 ä¸ªé‡å¤ ACK

    FastRetransmit --> FastRecovery: ssthresh = cwnd/2<br/>cwnd = ssthresh + 3

    FastRecovery --> FastRecovery: æ”¶åˆ°é‡å¤ ACK<br/>cwnd += MSS

    FastRecovery --> CongestionAvoidance: æ”¶åˆ°æ–° ACK<br/>cwnd = ssthresh

    SlowStart --> SlowStart: æ”¶åˆ° ACK<br/>cwnd += MSS
    CongestionAvoidance --> CongestionAvoidance: æ”¶åˆ° ACK<br/>cwnd += MSSÂ²/cwnd

    SlowStart --> SlowStart: RTO è¶…æ—¶<br/>ssthresh = cwnd/2<br/>cwnd = 1
    CongestionAvoidance --> SlowStart: RTO è¶…æ—¶<br/>ssthresh = cwnd/2<br/>cwnd = 1
    FastRecovery --> SlowStart: RTO è¶…æ—¶<br/>ssthresh = cwnd/2<br/>cwnd = 1
```

### 4.6.4 å®Œæ•´ç¤ºä¾‹ï¼šTCP Reno

```mermaid
---
config:
  xyChart:
    width: 900
    height: 500
---
xychart-beta
    title "TCP Reno æ‹¥å¡æ§åˆ¶ï¼šcwnd å˜åŒ–"
    x-axis "æ—¶é—´ (RTT)" 0 --> 25
    y-axis "cwnd (MSS å•ä½)" 0 --> 50
    line [1, 2, 4, 8, 16, 32, 33, 34, 35, 36, 37, 38, 39, 40, 20, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32]
```

**å›¾ç¤ºè¯´æ˜**ï¼š
- **RTT 1-5**ï¼ˆæ…¢å¯åŠ¨ï¼‰ï¼š1 â†’ 2 â†’ 4 â†’ 8 â†’ 16 â†’ 32
- **RTT 6-13**ï¼ˆæ‹¥å¡é¿å…ï¼‰ï¼š32 â†’ 40ï¼ˆçº¿æ€§å¢é•¿ï¼‰
- **RTT 14**ï¼ˆå¿«é€Ÿé‡ä¼ /æ¢å¤ï¼‰ï¼š
  - æ”¶åˆ° 3 ä¸ªé‡å¤ ACK
  - `ssthresh = 40 / 2 = 20`
  - `cwnd = 20 + 3 = 23`
- **RTT 15-25**ï¼ˆæ‹¥å¡é¿å…ï¼‰ï¼š23 â†’ 32ï¼ˆçº¿æ€§å¢é•¿ï¼‰

## 4.7 Linux ä¸­çš„æ‹¥å¡æ§åˆ¶ç®—æ³•

### 4.7.1 æŸ¥çœ‹å’Œè®¾ç½®æ‹¥å¡æ§åˆ¶ç®—æ³•

```bash
# æŸ¥çœ‹å¯ç”¨çš„æ‹¥å¡æ§åˆ¶ç®—æ³•
sysctl net.ipv4.tcp_available_congestion_control
# è¾“å‡º: net.ipv4.tcp_available_congestion_control = reno cubic

# æŸ¥çœ‹å½“å‰é»˜è®¤ç®—æ³•
sysctl net.ipv4.tcp_congestion_control
# è¾“å‡º: net.ipv4.tcp_congestion_control = cubic

# è®¾ç½®é»˜è®¤ç®—æ³•ï¼ˆéœ€è¦ root æƒé™ï¼‰
sudo sysctl -w net.ipv4.tcp_congestion_control=bbr

# æŸ¥çœ‹ç‰¹å®šè¿æ¥ä½¿ç”¨çš„ç®—æ³•
ss -tino | grep -A 1 ESTAB | grep -o 'cubic\|bbr\|reno'
```

### 4.7.2 å¸¸è§æ‹¥å¡æ§åˆ¶ç®—æ³•å¯¹æ¯”

| ç®—æ³• | å¹´ä»½ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **Reno** | 1990 | åŸºäºä¸¢åŒ…ï¼Œæ…¢å¯åŠ¨+æ‹¥å¡é¿å…+å¿«é€Ÿé‡ä¼ /æ¢å¤ | ä¼ ç»Ÿç®—æ³•ï¼ŒåŸºå‡†å‚è€ƒ |
| **Cubic** | 2008 | åŸºäºä¸¢åŒ…ï¼Œç«‹æ–¹å‡½æ•°å¢é•¿ï¼Œé«˜å¸¦å®½ç½‘ç»œä¼˜åŒ– | **Linux é»˜è®¤**ï¼Œå¹¿æ³›ä½¿ç”¨ |
| **BBR** | 2016 | åŸºäºå»¶è¿Ÿå’Œå¸¦å®½ï¼Œæ¢æµ‹æœ€ä¼˜å·¥ä½œç‚¹ | é«˜å»¶è¿Ÿã€ä¸¢åŒ…ç½‘ç»œï¼ˆå¦‚ 4G/5Gï¼‰ |
| **Vegas** | 1994 | åŸºäº RTT å˜åŒ–ï¼Œä¸»åŠ¨é¿å…æ‹¥å¡ | ä½å»¶è¿Ÿç½‘ç»œ |
| **Westwood** | 2001 | åŸºäºå¸¦å®½ä¼°è®¡ï¼Œé€‚åº”æ— çº¿ç½‘ç»œ | æ— çº¿ç½‘ç»œ |

### 4.7.3 Cubic ç®—æ³•ç®€ä»‹

**æ ¸å¿ƒæ€æƒ³**ï¼šä½¿ç”¨ç«‹æ–¹å‡½æ•°è°ƒæ•´ `cwnd`ï¼Œè€Œéçº¿æ€§å¢é•¿ã€‚

**çª—å£å¢é•¿**ï¼š
```
W(t) = C Ã— (t - K)Â³ + Wmax

å…¶ä¸­ï¼š
  Wmaxï¼šä¸¢åŒ…å‰çš„æœ€å¤§çª—å£
  Kï¼šè¾¾åˆ° Wmax æ‰€éœ€æ—¶é—´
  Cï¼šå¸¸æ•°ï¼ˆ0.4ï¼‰
  tï¼šè‡ªä¸Šæ¬¡ä¸¢åŒ…ä»¥æ¥çš„æ—¶é—´
```

**ç‰¹ç‚¹**ï¼š
- å¿«é€Ÿæ¢æµ‹ `Wmax` é™„è¿‘çš„å®¹é‡
- è¿œç¦» `Wmax` æ—¶å¢é•¿æ…¢ï¼Œæ¥è¿‘æ—¶å¢é•¿å¿«
- æ›´é€‚åˆé«˜å¸¦å®½å»¶è¿Ÿä¹˜ç§¯ï¼ˆBDPï¼‰ç½‘ç»œ

**Cubic vs Reno**ï¼š

```mermaid
---
config:
  xyChart:
    width: 900
    height: 500
---
xychart-beta
    title "Cubic vs Reno æ‹¥å¡çª—å£å¢é•¿å¯¹æ¯”"
    x-axis "æ—¶é—´ (RTT)" 0 --> 30
    y-axis "cwnd (MSS å•ä½)" 0 --> 100
    line [20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49]
    line [20, 22, 26, 32, 40, 50, 62, 76, 92, 92, 90, 86, 80, 72, 62, 50, 36, 20, 22, 26, 32, 40, 50, 62, 76, 92, 92, 90, 86, 80]
```

**å›¾ç¤º**ï¼š
- è“çº¿ï¼ˆRenoï¼‰ï¼šçº¿æ€§å¢é•¿
- æ©™çº¿ï¼ˆCubicï¼‰ï¼šç«‹æ–¹å‡½æ•°ï¼Œå¿«é€Ÿæ¢æµ‹å®¹é‡

### 4.7.4 BBR ç®—æ³•ç®€ä»‹

**æ ¸å¿ƒæ€æƒ³**ï¼šä¸åŸºäºä¸¢åŒ…ï¼Œè€Œæ˜¯é€šè¿‡æµ‹é‡ **RTT** å’Œ **å¸¦å®½**ï¼Œæ‰¾åˆ°æœ€ä¼˜å·¥ä½œç‚¹ã€‚

**BBR çš„å››ä¸ªé˜¶æ®µ**ï¼š
1. **STARTUP**ï¼ˆå¯åŠ¨ï¼‰ï¼šæŒ‡æ•°å¢é•¿ï¼Œå¿«é€Ÿå¡«æ»¡ç®¡é“
2. **DRAIN**ï¼ˆæ’ç©ºï¼‰ï¼šå‡å°å‘é€é€Ÿç‡ï¼Œæ’ç©ºé˜Ÿåˆ—
3. **PROBE_BW**ï¼ˆæ¢æµ‹å¸¦å®½ï¼‰ï¼šå‘¨æœŸæ€§å¢å‡é€Ÿç‡ï¼Œæ¢æµ‹æœ€å¤§å¸¦å®½
4. **PROBE_RTT**ï¼ˆæ¢æµ‹ RTTï¼‰ï¼šå®šæœŸé™ä½çª—å£ï¼Œæµ‹é‡æœ€å° RTT

**ä¼˜åŠ¿**ï¼š
- é«˜ä¸¢åŒ…ç‡ç½‘ç»œä»èƒ½ä¿æŒé«˜ååé‡
- é™ä½ç¼“å†²åŒºè†¨èƒ€ï¼ˆBufferbloatï¼‰
- é€‚åˆç§»åŠ¨ç½‘ç»œï¼ˆ4G/5Gï¼‰

**Linux å¯ç”¨ BBR**ï¼š
```bash
# æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ï¼ˆéœ€è¦ 4.9+ï¼‰
uname -r

# åŠ è½½ BBR æ¨¡å—
sudo modprobe tcp_bbr

# è®¾ç½®ä¸ºé»˜è®¤ç®—æ³•
sudo sysctl -w net.ipv4.tcp_congestion_control=bbr
sudo sysctl -w net.core.default_qdisc=fq

# æŒä¹…åŒ–é…ç½®
echo "net.ipv4.tcp_congestion_control=bbr" | sudo tee -a /etc/sysctl.conf
echo "net.core.default_qdisc=fq" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

## 4.8 å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹  1ï¼šè§‚å¯Ÿæ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…

```bash
# ä½¿ç”¨ ss å®æ—¶ç›‘æ§ cwnd å˜åŒ–
watch -n 0.5 'ss -tino | grep -A 1 ESTAB | grep cwnd'

# å¦ä¸€ä¸ªç»ˆç«¯ï¼šä¸‹è½½å¤§æ–‡ä»¶
wget http://example.com/large_file.zip
```

**è§‚å¯Ÿä»»åŠ¡**ï¼š
1. åˆå§‹ `cwnd` å€¼ï¼ˆé€šå¸¸æ˜¯ 10ï¼‰
2. æ…¢å¯åŠ¨é˜¶æ®µçš„æŒ‡æ•°å¢é•¿
3. è¾¾åˆ° `ssthresh` åçš„çº¿æ€§å¢é•¿

### ç»ƒä¹  2ï¼šæ¨¡æ‹Ÿä¸¢åŒ…è§¦å‘å¿«é€Ÿé‡ä¼ 

```bash
# ä½¿ç”¨ tc æ¨¡æ‹Ÿ 5% ä¸¢åŒ…ç‡
sudo tc qdisc add dev eth0 root netem loss 5%

# æŠ“åŒ…è§‚å¯Ÿé‡å¤ ACK å’Œå¿«é€Ÿé‡ä¼ 
sudo tcpdump -i eth0 -nn 'tcp' -vv | grep -E 'dup ack|retransmission'

# å¯åŠ¨ä¼ è¾“
curl http://example.com/file.zip -o /dev/null

# æ¢å¤ç½‘ç»œ
sudo tc qdisc del dev eth0 root
```

### ç»ƒä¹  3ï¼šå¯¹æ¯”ä¸åŒæ‹¥å¡æ§åˆ¶ç®—æ³•

**æµ‹è¯•è„šæœ¬**ï¼š
```bash
#!/bin/bash
# å¯¹æ¯” Reno, Cubic, BBR çš„æ€§èƒ½

for algo in reno cubic bbr; do
    echo "Testing $algo..."
    sudo sysctl -w net.ipv4.tcp_congestion_control=$algo

    # ä½¿ç”¨ iperf3 æµ‹è¯•ååé‡
    iperf3 -c example.com -t 30 -i 1 | tee "${algo}_result.txt"

    sleep 5
done
```

**åˆ†æ**ï¼š
- ååé‡ï¼ˆMbpsï¼‰
- RTT å˜åŒ–
- ä¸¢åŒ…æ¢å¤é€Ÿåº¦

### ç»ƒä¹  4ï¼šç›‘æ§æ‹¥å¡äº‹ä»¶

```bash
# æŸ¥çœ‹æ‹¥å¡ç›¸å…³ç»Ÿè®¡
netstat -s | grep -i congest

# è¾“å‡ºç¤ºä¾‹ï¼š
#    1234 times the congestion window was reduced
#    567 resets received for embryonic SYN_RECV sockets
#    89 fast retransmits

# å®æ—¶ç›‘æ§æ‹¥å¡çª—å£å˜åŒ–
ss -tino | grep -A 3 ESTAB | grep -E 'cwnd|ssthresh|retrans'
```

## 4.9 å°ç»“

æœ¬ç« è¯¦ç»†è®²è§£äº† TCP æ‹¥å¡æ§åˆ¶æœºåˆ¶ï¼š

âœ… **å…³é”®è¦ç‚¹**ï¼š
1. **æ…¢å¯åŠ¨**ï¼šæŒ‡æ•°å¢é•¿ï¼Œå¿«é€Ÿæ¢æµ‹ç½‘ç»œå®¹é‡
2. **æ‹¥å¡é¿å…**ï¼šçº¿æ€§å¢é•¿ï¼Œè°¨æ…å¢åŠ çª—å£
3. **å¿«é€Ÿé‡ä¼ **ï¼šæ”¶åˆ° 3 ä¸ªé‡å¤ ACK ç«‹å³é‡ä¼ 
4. **å¿«é€Ÿæ¢å¤**ï¼šé¿å…å›åˆ°æ…¢å¯åŠ¨ï¼Œå¿«é€Ÿæ¢å¤ååé‡
5. **ç°ä»£ç®—æ³•**ï¼šCubicï¼ˆLinux é»˜è®¤ï¼‰ã€BBRï¼ˆåŸºäºå»¶è¿Ÿå’Œå¸¦å®½ï¼‰

ğŸ”— **ä¸ Linux å®ç°çš„è”ç³»**ï¼š
- `ss -tino` æŸ¥çœ‹ `cwnd`ã€`ssthresh`ã€é‡ä¼ æ¬¡æ•°
- `sysctl` è®¾ç½®æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼ˆRenoã€Cubicã€BBRï¼‰
- `tc netem` æ¨¡æ‹Ÿä¸¢åŒ…ã€å»¶è¿Ÿï¼Œæµ‹è¯•æ‹¥å¡æ§åˆ¶
- `iperf3` æµ‹è¯•ä¸åŒç®—æ³•çš„æ€§èƒ½

ğŸ“Š **ç®—æ³•å¯¹æ¯”**ï¼š
- **Reno**ï¼šç»å…¸åŸºå‡†ï¼ŒåŸºäºä¸¢åŒ…
- **Cubic**ï¼šé«˜å¸¦å®½ç½‘ç»œä¼˜åŒ–ï¼Œç«‹æ–¹å¢é•¿
- **BBR**ï¼šé«˜å»¶è¿Ÿ/ä¸¢åŒ…ç½‘ç»œä¼˜åŒ–ï¼ŒåŸºäº RTT å’Œå¸¦å®½

ğŸ“š **ä¸‹ä¸€ç« é¢„å‘Š**ï¼š
ç¬¬äº”ç« å°†è®²è§£ TCP é«˜æ€§èƒ½æ‰©å±•ï¼ŒåŒ…æ‹¬çª—å£ç¼©æ”¾ï¼ˆWindow Scaleï¼‰ã€æ—¶é—´æˆ³ï¼ˆTimestampsï¼‰ã€é€‰æ‹©æ€§ç¡®è®¤ï¼ˆSACKï¼‰ç­‰æœºåˆ¶ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•åº”å¯¹"é•¿è‚¥ç½‘ç»œ"ï¼ˆLong Fat Networksï¼‰çš„æŒ‘æˆ˜ã€‚

---

**å‚è€ƒèµ„æ–™**ï¼š
- RFC 5681: TCP Congestion Control
- RFC 8312: CUBIC for Fast Long-Distance Networks
- [BBR: Congestion-Based Congestion Control](https://queue.acm.org/detail.cfm?id=3022184)
- Linux å†…æ ¸æ–‡æ¡£ï¼š[tcp(7) man page](https://man7.org/linux/man-pages/man7/tcp.7.html)
